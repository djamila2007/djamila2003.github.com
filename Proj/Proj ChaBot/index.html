<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chatbot IA - Th√®me Beauty</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>

<body>
<div class="stage">

  <div class="chat-container">
    <div class="chat-header">ü§ñ Mini Chatbot IA</div>

    <div id="messages" class="messages"></div>

    <div class="chat-footer">

        <div id="typing" style="display:none; color:#111827; font-size:0.9rem; margin:6px 0;">Le bot est en train de r√©pondre‚Ä¶</div>
      <input id="msg" class="form-control" placeholder="√âcris ton message...">
<button id="sendBtn" class="btn btn-primary"><span id="btnText">Envoyer</span></button>

    </div>

    <div class="hint">
      Apprendre : <code>apprendre : question = r√©ponse</code><br>
      Envoyer mail : <code>mail : destinataire + objet + message</code><br>
      Recherche : <code>recherche : trouve</code>
    </div>
  </div>

</div>

<!-- Bootstrap JS (optionnel) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* Frontend am√©lior√© pour ton chat.php */
const messagesEl = document.getElementById("messages");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const btnText = document.getElementById("btnText");
const typingEl = document.getElementById("typing");

const API_URL = "chat.php"; // URL du backend

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}

function addMessage(text, who, meta = null){
  const wrapper = document.createElement("div");
  wrapper.className = "message " + who;

  const p = document.createElement("div");
  p.textContent = text;
  wrapper.appendChild(p);

  const small = document.createElement("div");
  small.className = "meta";
  small.textContent = meta ?? nowTime();
  wrapper.appendChild(small);

  messagesEl.appendChild(wrapper);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function setLoading(isLoading){
  sendBtn.disabled = isLoading;
  input.disabled = isLoading;
  if(isLoading){
    btnText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>&nbsp;Envoi‚Ä¶';
    typingEl.style.display = "block";
  } else {
    btnText.textContent = "Envoyer";
    typingEl.style.display = "none";
  }
}

async function fetchWithTimeout(url, options = {}, timeout = 12000){
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  options.signal = controller.signal;
  try {
    const res = await fetch(url, options);
    clearTimeout(id);
    return res;
  } catch (err) {
    clearTimeout(id);
    throw err;
  }
}

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  addMessage(text, "user");
  input.value = "";
  setLoading(true);

  try {
    const res = await fetchWithTimeout(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    if(!res.ok){
      addMessage("Erreur serveur : " + res.status, "bot");
      return;
    }

    const data = await res.json();

if(data.results){
    // Message principal avec HTML simple
    addMessageHtml(`<strong>${data.reply}</strong>`, "bot");

    // Parcours des r√©sultats
    data.results.forEach(r => {
        const html = `
          <p>
            <strong><a href="${r.link}" target="_blank">${r.title}</a></strong><br>
            ${r.snippet}
          </p>
        `;
        addMessageHtml(html, "bot");
    });
}

 else if(data.reply){
      addMessage(data.reply, "bot");
    } else if(data.error){
      addMessage("Erreur : " + data.error, "bot");
    } else {
      addMessage("R√©ponse inconnue du serveur.", "bot");
    }

  } catch (err) {
    if(err.name === 'AbortError'){
      addMessage("La requ√™te a expir√©.", "bot");
    } else {
      addMessage("Erreur de connexion au serveur.", "bot");
    }
  } finally {
    setLoading(false);
    input.focus();
  }
}

function addMessageHtml(html, who, meta = null){
  const wrapper = document.createElement("div");
  wrapper.className = "message " + who;

  const div = document.createElement("div");
  div.innerHTML = html; // autorise HTML ici
  wrapper.appendChild(div);

  const small = document.createElement("div");
  small.className = "meta";
  small.textContent = meta ?? nowTime();
  wrapper.appendChild(small);

  messagesEl.appendChild(wrapper);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}


// handlers
sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// message de bienvenue
addMessage("Bienvenue üôÇ Je suis ton chatbot. Parle avec moi, apprends-moi ou envoie un mail !", "bot");
input.focus();

</script>
</body>
</html>